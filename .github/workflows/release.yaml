# This workflow builds and pushes a Docker image to the GitHub Container Registry (GHCR).
# It is designed to handle three distinct scenarios:
# Production Releases: Triggered when a new Release is 'published' on GitHub.
#    - Tags the image with semantic versions (e.g., 1.2.3, 1.2, 1) and 'latest'.
# Development Builds: Triggered on every push to the 'dev' branch.
#    - Tags the image with 'dev'.
# Manual Test Builds: Triggered manually via 'workflow_dispatch'.
#    - Tags the image with the version provided as input (e.g., 'test-1.0.0').

name: Release Uraniarr

# This section defines when the workflow will run.
on:
  # Main/Production: Runs when you create a new GitHub Release
  release:
    types: [published]

  # Dev: Runs on every push to the 'dev' branch
  push:
    branches:
      - 'development'

  # Manual: Runs when you trigger it manually from the Actions tab
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to use for testing (e.g., test-1.0.0)'
        required: true
        default: 'test-1.0.0'

# A workflow run is made up of one or more jobs.
jobs:
  release:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    # Permissions required by this job
    permissions:
      contents: read      # To check out the repository code
      packages: write     # To push Docker images to GHCR

    steps:
      # Get the source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up QEMU for multi-architecture builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker Buildx, the advanced builder toolkit
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Log in to the GitHub Container Registry (GHCR)
      # GITHUB_TOKEN which is automatically created for each workflow run.
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}    # The user/org triggering the workflow
          password: ${{ github.token }}    # A temporary token

      # Prepare a lowercase repository name
      # Docker image names are conventionally lowercase.
      # This creates an environment variable $REPO_NAME_LOWERCASE
      - name: Lowercase repository name
        id: repo_name_lowercase
        run: echo "REPO_NAME_LOWERCASE=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # Generate Docker tags and labels dynamically
      # This is the core logic for tagging.
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Define the base image name: ghcr.io/owner/repo
          images: ghcr.io/${{ env.REPO_NAME_LOWERCASE }}

          # Define the tagging logic.
          # The 'enable' attribute is key to conditional tagging.
          tags: |
            # Main/Production Tags (on 'release')
            type=semver,pattern={{version}},enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{major}},enable=${{ github.event_name == 'release' }}
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
          
            # Dev Tags (when pushing to 'dev' branch)
            # Static dev tag
            type=raw,value=dev,enable=${{ github.event_name == 'push' && github.ref_name == 'dev' }}
            # Unique SHA tag for dev builds (recommended)
            type=sha,prefix=dev-,enable=${{ github.event_name == 'push' && github.ref_name == 'dev' }}
          
            # Manual Test Tags (manual trigger)
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event_name == 'workflow_dispatch' }}


      # Build and push the Docker image
      # This step uses the tags and labels generated by the 'meta' step.
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .                          # Build from the root directory
          platforms: linux/amd64            # Specify target platform(s)
          push: true                          # Push the image after building
          tags: ${{ steps.meta.outputs.tags }}    # Use the tags from the 'meta' step
          labels: ${{ steps.meta.outputs.labels }}  # Use the labels from the 'meta' step
          cache-from: type=gha                # Use GitHub Actions cache for build layers
          cache-to: type=gha,mode=max         # Write build layers to the cache
